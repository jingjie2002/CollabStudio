#!/bin/bash
# =============================================================================
# ğŸš€ CollabServer ä¸€é”®éƒ¨ç½²è„šæœ¬ v2.0 (Systemd é›†æˆç‰ˆ)
# =============================================================================
# ä½œè€…: AI ç”Ÿæˆï¼Œè¯·ä»”ç»†é˜…è¯»æ¯ä¸€è¡Œæ³¨é‡Šç†è§£å…¶ä½œç”¨
# ç”¨é€”: åœ¨ Linux æœåŠ¡å™¨ä¸Šå¿«é€Ÿéƒ¨ç½² CollabServer
# ä½¿ç”¨: chmod +x deploy.sh && sudo ./deploy.sh
# =============================================================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºè„šæœ¬
        # è¿™æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹çš„åŸºæœ¬åŸåˆ™ï¼šfail fast

# =============================================================================
# ğŸ“ é¢œè‰²å®šä¹‰ï¼ˆè®©è¾“å‡ºæ›´ç¾è§‚æ˜“è¯»ï¼‰
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å½©è‰²æ¶ˆæ¯çš„å‡½æ•°
info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; exit 1; }

echo ""
echo -e "${BLUE}============================================${NC}"
echo -e "${BLUE}   CollabServer éƒ¨ç½²è„šæœ¬ v2.0 (Systemd)${NC}"
echo -e "${BLUE}============================================${NC}"
echo ""

# =============================================================================
# æ­¥éª¤ 0ï¼šæ£€æŸ¥ root æƒé™
# =============================================================================
# systemd æ“ä½œéœ€è¦ root æƒé™ï¼Œæ‰€ä»¥å¿…é¡»ç”¨ sudo è¿è¡Œ
# =============================================================================
if [ "$EUID" -ne 0 ]; then
    error "è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬ï¼\n    ç”¨æ³•: sudo ./deploy.sh"
fi

# =============================================================================
# æ­¥éª¤ 0.5ï¼šé€’å½’ä¿®æ­£æ–‡ä»¶æƒé™
# =============================================================================
# ç¡®ä¿æ‰€æœ‰éƒ¨ç½²æ–‡ä»¶å…·æœ‰æ­£ç¡®çš„æƒé™
# è¿™å¯ä»¥ä¿®å¤ä» Windows ä¸Šä¼ åå¯èƒ½å‡ºç°çš„æƒé™é—®é¢˜
# =============================================================================
info "é€’å½’ä¿®æ­£æ–‡ä»¶æƒé™..."
# æ‰€æœ‰æ–‡ä»¶è®¾ä¸º 644 (å¯è¯»å†™)
find . -maxdepth 1 -type f -exec chmod 644 {} \; 2>/dev/null || true
# ç›®å½•è®¾ä¸º 755 (å¯è¿›å…¥)
find . -maxdepth 1 -type d -exec chmod 755 {} \; 2>/dev/null || true
# ç¡®ä¿æ‰€æœ‰è€…æ˜¯ ubuntu
chown -R ubuntu:ubuntu . 2>/dev/null || true
success "æ–‡ä»¶æƒé™å·²ä¿®æ­£"

# =============================================================================
# æ­¥éª¤ 1ï¼šæ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
# =============================================================================
# collab_server æ˜¯ Go ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
# å¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜ç”¨æˆ·è¿˜æ²¡æœ‰ç¼–è¯‘ï¼Œéœ€è¦æç¤º
# =============================================================================
info "æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶..."
if [ ! -f "./collab_server" ]; then
    error "æœªæ‰¾åˆ° collab_server å¯æ‰§è¡Œæ–‡ä»¶ï¼è¯·å…ˆåœ¨ Windows ä¸Šäº¤å‰ç¼–è¯‘ï¼š
    \$env:GOOS='linux'; \$env:GOARCH='amd64'; go build -ldflags '-s -w' -o collab_server ."
fi
success "æ‰¾åˆ° collab_server"

# =============================================================================
# æ­¥éª¤ 2ï¼šèµ‹äºˆæ‰§è¡Œæƒé™
# =============================================================================
# Linux ä¸‹ï¼Œæ–°åˆ›å»ºçš„æ–‡ä»¶é»˜è®¤æ²¡æœ‰æ‰§è¡Œæƒé™
# chmod +x æ·»åŠ æ‰§è¡Œæƒé™ï¼Œè®©ç³»ç»ŸçŸ¥é“è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢«è¿è¡Œ
# =============================================================================
info "è®¾ç½®æ‰§è¡Œæƒé™..."
chmod +x ./collab_server
success "æ‰§è¡Œæƒé™å·²è®¾ç½®"

# =============================================================================
# æ­¥éª¤ 3ï¼šèµ‹äºˆä½ç«¯å£ç»‘å®šèƒ½åŠ›ï¼ˆæ ¸å¿ƒï¼ï¼‰
# =============================================================================
# é—®é¢˜ï¼šLinux ä¸­ï¼Œåªæœ‰ root æ‰èƒ½ç»‘å®š 1024 ä»¥ä¸‹çš„ç«¯å£ï¼ˆå¦‚ 80ï¼‰
# è§£å†³ï¼šä½¿ç”¨ setcap èµ‹äºˆäºŒè¿›åˆ¶æ–‡ä»¶ã€Œç»‘å®šä½ç«¯å£ã€çš„èƒ½åŠ›
# cap_net_bind_serviceï¼šå…è®¸ç¨‹åºç»‘å®šåˆ° < 1024 çš„ç«¯å£
# +epï¼šeffectiveï¼ˆç”Ÿæ•ˆï¼‰+ permittedï¼ˆå…è®¸ï¼‰
# =============================================================================
info "èµ‹äºˆä½ç«¯å£ç»‘å®šèƒ½åŠ›ï¼ˆå…è®¸é root ç”¨æˆ·ç»‘å®š 80 ç«¯å£ï¼‰..."
if command -v setcap &> /dev/null; then
    setcap 'cap_net_bind_service=+ep' ./collab_server
    success "setcap æƒé™å·²è®¾ç½®"
else
    warning "setcap å‘½ä»¤ä¸å­˜åœ¨ï¼Œå¦‚æœä½¿ç”¨ 80 ç«¯å£å¯èƒ½éœ€è¦ä»¥ root èº«ä»½è¿è¡Œ"
fi

# =============================================================================
# æ­¥éª¤ 4ï¼šæ£€æŸ¥ .env é…ç½®æ–‡ä»¶
# =============================================================================
# .env æ–‡ä»¶åŒ…å«å…³é”®é…ç½®ï¼ˆJWT_SECRET, PORT ç­‰ï¼‰
# å¦‚æœä¸å­˜åœ¨ï¼Œä» .env.example å¤åˆ¶ä¸€ä»½æ¨¡æ¿
# =============================================================================
info "æ£€æŸ¥ .env é…ç½®æ–‡ä»¶..."
if [ ! -f "./.env" ]; then
    if [ -f "./.env.example" ]; then
        cp ./.env.example ./.env
        warning ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå·²ä» .env.example å¤åˆ¶"
        warning "è¯·ç«‹å³ç¼–è¾‘ .env ä¿®æ”¹ JWT_SECRETï¼"
        echo ""
        echo -e "${YELLOW}å…³é”®é…ç½®é¡¹æ£€æŸ¥ï¼š${NC}"
        echo "  - JWT_SECRET: å¿…é¡»ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²"
        echo "  - CORS_ORIGINS: å¿…é¡»è®¾ç½®ä¸ºä½ çš„å‰ç«¯åŸŸå"
        echo "  - PORT: é»˜è®¤ 80ï¼Œå¯æŒ‰éœ€ä¿®æ”¹"
        echo ""
        echo -e "${RED}â›” è¯·ç¼–è¾‘ .env åé‡æ–°è¿è¡Œæ­¤è„šæœ¬${NC}"
        exit 1
    else
        error ".env å’Œ .env.example éƒ½ä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶å®Œæ•´æ€§"
    fi
else
    success ".env é…ç½®æ–‡ä»¶å­˜åœ¨"
fi

# éªŒè¯å…³é”®é…ç½®é¡¹
info "éªŒè¯ JWT_SECRET é…ç½®..."
JWT_SECRET=$(grep -E "^JWT_SECRET=" .env | cut -d '=' -f2)
if [ -z "$JWT_SECRET" ] || [ "$JWT_SECRET" = "your_secret_key_here" ] || [ "$JWT_SECRET" = "your_secret_key_here_must_change_in_production" ]; then
    error "JWT_SECRET æœªé…ç½®æˆ–ä½¿ç”¨äº†é»˜è®¤å€¼ï¼è¿™æ˜¯ä¸¥é‡çš„å®‰å…¨éšæ‚£ï¼
    è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå°† JWT_SECRET è®¾ç½®ä¸ºéšæœºå­—ç¬¦ä¸²
    ç”Ÿæˆæ–¹å¼: openssl rand -base64 32"
fi
success "JWT_SECRET å·²é…ç½®"

# =============================================================================
# æ­¥éª¤ 5ï¼šæ¸…ç† 80 ç«¯å£å ç”¨
# =============================================================================
# å¦‚æœç›®æ ‡ç«¯å£ï¼ˆé»˜è®¤ 80ï¼‰è¢«å ç”¨ï¼Œéœ€è¦å…ˆæ¸…ç†
# è¿™é‡Œä½¿ç”¨ lsof æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹ï¼Œss ä½œä¸ºå¤‡é€‰
# =============================================================================
PORT=$(grep -E "^PORT=" .env 2>/dev/null | cut -d '=' -f2 || echo "80")
PORT=${PORT:-80}  # å¦‚æœä¸ºç©ºï¼Œé»˜è®¤ 80

info "æ£€æŸ¥ç«¯å£ $PORT å ç”¨æƒ…å†µ..."

# ğŸŸ¢ ä¼˜åŒ–ï¼šä¼˜å…ˆå°è¯•é€šè¿‡ systemctl ä¼˜é›…åœæ­¢æœåŠ¡
if systemctl is-active --quiet collab 2>/dev/null; then
    info "æ£€æµ‹åˆ° collab æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå°è¯•ä¼˜é›…åœæ­¢..."
    systemctl stop collab 2>/dev/null || true
    sleep 2  # ç­‰å¾…æœåŠ¡å®Œå…¨åœæ­¢
    
    if systemctl is-active --quiet collab 2>/dev/null; then
        warning "systemctl stop å¤±è´¥ï¼Œå°†å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹"
    else
        success "collab æœåŠ¡å·²ä¼˜é›…åœæ­¢"
    fi
fi

# æ£€æŸ¥ç«¯å£æ˜¯å¦ä»è¢«å ç”¨ï¼ˆå¯èƒ½æ˜¯å…¶ä»–è¿›ç¨‹æˆ–æœåŠ¡æœªå®Œå…¨åœæ­¢ï¼‰
if command -v lsof &> /dev/null; then
    PIDS=$(lsof -t -i:$PORT 2>/dev/null || true)
elif command -v ss &> /dev/null; then
    PIDS=$(ss -tlnp | grep ":$PORT " | grep -oP '(?<=pid=)\d+' || true)
else
    warning "lsof å’Œ ss å‘½ä»¤éƒ½ä¸å­˜åœ¨ï¼Œè·³è¿‡ç«¯å£æ£€æŸ¥"
    PIDS=""
fi

if [ -n "$PIDS" ]; then
    warning "ç«¯å£ $PORT ä»è¢«ä»¥ä¸‹è¿›ç¨‹å ç”¨: $PIDS"
    info "å¼ºåˆ¶ç»ˆæ­¢è¿™äº›è¿›ç¨‹..."
    for PID in $PIDS; do
        kill -9 $PID 2>/dev/null || true
        info "å·²ç»ˆæ­¢è¿›ç¨‹ $PID"
    done
    sleep 1  # ç­‰å¾…ç«¯å£é‡Šæ”¾
    success "ç«¯å£ $PORT å·²å¼ºåˆ¶æ¸…ç†"
else
    success "ç«¯å£ $PORT æœªè¢«å ç”¨"
fi

# =============================================================================
# æ­¥éª¤ 6ï¼šåˆ›å»º uploads ç›®å½•
# =============================================================================
# uploads ç›®å½•ç”¨äºå­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å’Œæ–‡ä»¶
# å¦‚æœä¸å­˜åœ¨ï¼ŒæœåŠ¡å¯åŠ¨åä¸Šä¼ åŠŸèƒ½ä¼šæŠ¥é”™
# =============================================================================
info "æ£€æŸ¥ uploads ç›®å½•..."
if [ ! -d "./uploads" ]; then
    mkdir -p ./uploads
    success "uploads ç›®å½•å·²åˆ›å»º"
fi
# 755 = rwxr-xr-x (æ‰€æœ‰è€…å¯è¯»å†™æ‰§è¡Œï¼Œå…¶ä»–äººå¯è¯»æ‰§è¡Œ)
chmod 755 ./uploads
# ç¡®ä¿ ubuntu ç”¨æˆ·æ‹¥æœ‰è¯¥ç›®å½•
chown ubuntu:ubuntu ./uploads
success "uploads ç›®å½•æƒé™å·²è®¾ç½® (755, owner: ubuntu)"

# =============================================================================
# æ­¥éª¤ 7ï¼šåˆ›å»ºæ—¥å¿—æ–‡ä»¶
# =============================================================================
# ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨ä¸” ubuntu ç”¨æˆ·å¯å†™å…¥
# =============================================================================
info "æ£€æŸ¥æ—¥å¿—æ–‡ä»¶..."
if [ ! -f "/var/log/collab.log" ]; then
    touch /var/log/collab.log
fi
chown ubuntu:ubuntu /var/log/collab.log
chmod 644 /var/log/collab.log
success "æ—¥å¿—æ–‡ä»¶å·²å°±ç»ª (/var/log/collab.log)"

# =============================================================================
# æ­¥éª¤ 8ï¼šå®‰è£… systemd æœåŠ¡
# =============================================================================
# å°† collab.service æ‹·è´åˆ°ç³»ç»Ÿç›®å½•ï¼Œè®© systemd æ¥ç®¡æœåŠ¡
# daemon-reloadï¼šè®© systemd é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
# =============================================================================
info "å®‰è£… systemd æœåŠ¡..."

if [ ! -f "./collab.service" ]; then
    error "æœªæ‰¾åˆ° collab.service æ–‡ä»¶ï¼è¯·ç¡®ä¿éƒ¨ç½²æ–‡ä»¶å®Œæ•´"
fi

# æ‹·è´æœåŠ¡é…ç½®åˆ°ç³»ç»Ÿç›®å½•
cp ./collab.service /etc/systemd/system/collab.service
success "æœåŠ¡é…ç½®å·²æ‹·è´åˆ° /etc/systemd/system/"

# é‡æ–°åŠ è½½ systemd é…ç½®
systemctl daemon-reload
success "systemd é…ç½®å·²é‡è½½"

# è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
systemctl enable collab
success "å·²è®¾ç½®å¼€æœºè‡ªå¯åŠ¨"

# =============================================================================
# æ­¥éª¤ 9ï¼šå¯åŠ¨/é‡å¯æœåŠ¡
# =============================================================================
# ä½¿ç”¨ systemctl restart è€Œéæ‰‹åŠ¨ nohup
# è¿™ä¼šï¼š
#   1. å‘é€ SIGTERM ç»™æ—§è¿›ç¨‹ï¼ˆè§¦å‘ä¼˜é›…åœæœºï¼‰
#   2. ç­‰å¾…æ—§è¿›ç¨‹é€€å‡º
#   3. å¯åŠ¨æ–°è¿›ç¨‹
# =============================================================================
echo ""
info "æ­£åœ¨å¯åŠ¨ CollabServer..."

# ä½¿ç”¨ systemctl restartï¼ˆå¦‚æœæœåŠ¡æœªè¿è¡Œä¼šç›´æ¥å¯åŠ¨ï¼‰
systemctl restart collab

# ç­‰å¾… 2 ç§’è®©æœåŠ¡å¯åŠ¨
sleep 2

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if systemctl is-active --quiet collab; then
    success "CollabServer å¯åŠ¨æˆåŠŸï¼"
    echo ""
    echo -e "${GREEN}============================================${NC}"
    echo -e "${GREEN}   ğŸ‰ éƒ¨ç½²æˆåŠŸï¼${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo ""
    echo "ğŸ“ æœåŠ¡åœ°å€: http://$(hostname -I | awk '{print $1}'):$PORT"
    echo "ğŸ“‹ æ—¥å¿—æ–‡ä»¶: /var/log/collab.log"
    echo "ğŸ” æŸ¥çœ‹æ—¥å¿—: sudo tail -f /var/log/collab.log"
    echo "ğŸ“Š æœåŠ¡çŠ¶æ€: sudo systemctl status collab"
    echo "ğŸ›‘ åœæ­¢æœåŠ¡: sudo systemctl stop collab"
    echo "ğŸ”„ é‡å¯æœåŠ¡: sudo systemctl restart collab"
    echo ""
else
    error "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼è¯·æŸ¥çœ‹æ—¥å¿—: sudo journalctl -u collab -n 50"
fi
